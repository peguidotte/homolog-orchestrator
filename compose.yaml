# =============================================================================
# Aegis Test Orchestrator - Docker Compose
# =============================================================================
# Usage:
#   Pub/Sub:   docker compose --profile pubsub up -d
#
# Make sure the Pub/Sub emulator is running for local development.
# =============================================================================

services:
  # ===========================================================================
  # Core Services (always started)
  # ===========================================================================
  postgres:
    image: 'postgres:16-alpine'
    container_name: aegis-postgres
    environment:
      POSTGRES_DB: aegis_test
      POSTGRES_USER: aegis
      POSTGRES_PASSWORD: ${DB_PASSWORD:-aegis123}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aegis -d aegis_test"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: 'dpage/pgadmin4:latest'
    container_name: aegis-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@aegis.dev
      PGADMIN_DEFAULT_PASSWORD: ${DB_PASSWORD:-aegis123}
    ports:
      - '5050:80'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy

  # ===========================================================================
  # Messaging: GCP Pub/Sub Emulator (profile: pubsub)
  # ===========================================================================
  # pubsub-emulator:
  #   image: 'gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators'
  #   container_name: aegis-pubsub
  #   profiles:
  #     - pubsub
  #   command: >
  #     gcloud beta emulators pubsub start
  #     --project=${AEGIS_PUBSUB_PROJECT_ID:-aegis-local}
  #     --host-port=0.0.0.0:8085
  #   ports:
  #     - '8085:8085'    
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:8085 || exit 1"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s

volumes:
  postgres_data:
  pgadmin_data:
